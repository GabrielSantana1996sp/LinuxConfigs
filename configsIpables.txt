#!/bin/bash
set -euo pipefail

# ====== Configuráveis ======
ROLLBACK_DELAY=120    # segundos até o rollback automático
PERSIST=true          # true para ativar persistência automática em /etc
# ===========================

# checa existência dos comandos
command -v iptables >/dev/null 2>&1 || { echo "iptables não encontrado no PATH"; exit 1; }
command -v ip6tables >/dev/null 2>&1 || { echo "ip6tables não encontrado no PATH"; exit 1; }

# 1) salva estado atual (elevado corretamente)
sudo sh -c 'iptables-save > /root/iptables-before.v4'
sudo sh -c 'ip6tables-save > /root/iptables-before.v6'
echo "Estados salvos em /root/iptables-before.v4 e /root/iptables-before.v6"

# 2) agenda rollback automático (executado como root)
(sleep "${ROLLBACK_DELAY}" && echo "Rollback automático: restaurando regras..." && sudo iptables-restore < /root/iptables-before.v4 && sudo ip6tables-restore < /root/iptables-before.v6) &
ROLLBACK_BG_PID=$!
echo "Rollback agendado (PID do job): ${ROLLBACK_BG_PID} — será executado em ${ROLLBACK_DELAY}s se não for cancelado"

# função para cancelar rollback background
_cancel_rollback() {
  if ps -p "${ROLLBACK_BG_PID}" >/dev/null 2>&1; then
    kill "${ROLLBACK_BG_PID}" 2>/dev/null || true
    echo "Rollback cancelado (PID ${ROLLBACK_BG_PID})"
  fi
}
# garante que o rollback seja cancelado se o script terminar normalmente
trap _cancel_rollback EXIT

# 3) Aplica regras seguras (IPv4)
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X

sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# preserva acesso às VMs/bridge (conforme seu estado atual)
sudo iptables -A INPUT -s 192.168.122.0/24 -j ACCEPT
sudo iptables -A INPUT -i virbr0 -j ACCEPT

# portas essenciais (aceitar novas conexões)
sudo iptables -A INPUT -p tcp --dport 22  -m conntrack --ctstate NEW -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80  -m conntrack --ctstate NEW -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# ICMP básico
sudo iptables -A INPUT -p icmp -j ACCEPT

echo "Regras IPv4 aplicadas."

# 4) Aplica regras seguras (IPv6)
sudo ip6tables -F
sudo ip6tables -X
sudo ip6tables -t mangle -F
sudo ip6tables -t mangle -X

sudo ip6tables -P INPUT DROP
sudo ip6tables -P FORWARD DROP
sudo ip6tables -P OUTPUT ACCEPT

sudo ip6tables -A INPUT -i lo -j ACCEPT
sudo ip6tables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

sudo ip6tables -A INPUT -p tcp --dport 22  -m conntrack --ctstate NEW -j ACCEPT
sudo ip6tables -A INPUT -p tcp --dport 80  -m conntrack --ctstate NEW -j ACCEPT
sudo ip6tables -A INPUT -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# ICMPv6
sudo ip6tables -A INPUT -p ipv6-icmp -j ACCEPT

echo "Regras IPv6 aplicadas."

# 5) SSHGUARD (simples usando recent) — idempotente
sudo iptables -N SSHGUARD 2>/dev/null || true
sudo iptables -D INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j SSHGUARD 2>/dev/null || true
sudo iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j SSHGUARD
sudo iptables -F SSHGUARD || true
sudo iptables -A SSHGUARD -m recent --set --name SSH --rsource
sudo iptables -A SSHGUARD -m recent --update --seconds 60 --hitcount 6 --name SSH --rsource -j DROP

# 6) LOG limitado para drops
sudo iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "IPTables-DROP: " --log-level 4

# 7) mostra status
echo "--------------------"
echo "iptables (IPv4):"
sudo iptables -L -n -v
echo "--------------------"
echo "ip6tables (IPv6):"
sudo ip6tables -L -n -v
echo "--------------------"

echo "Teste em outra sessão SSH: SSH, HTTP e HTTPS."
echo "Se estiver OK, cancele o rollback com: jobs -l; kill ${ROLLBACK_BG_PID}  (ou 'kill %1' se for job 1)."

# 8) Persistência automática (se PERSIST=true)
if [ "${PERSIST}" = true ]; then
  echo "Persistência automática ativada: salvando regras e instalando iptables-persistent se necessário."
  # tenta instalar iptables-persistent se não existir (apenas Debian/Ubuntu)
  if ! dpkg -l iptables-persistent >/dev/null 2>&1; then
    echo "Instalando iptables-persistent (modo não-interativo)..."
    sudo apt update
    sudo DEBIAN_FRONTEND=noninteractive apt install -y iptables-persistent || true
  fi
  sudo sh -c 'iptables-save > /etc/iptables/rules.v4'
  sudo sh -c 'ip6tables-save > /etc/iptables/rules.v6'
  echo "Regras salvas em /etc/iptables/rules.v4 e /etc/iptables/rules.v6"
fi

# fim do script (trap EXIT cancela rollback se chegamos até aqui)
exit 0
